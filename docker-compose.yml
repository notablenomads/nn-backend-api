services:
  api:
    image: mrdevx/nn-backend-api:latest
    environment:
      # Application
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}
      HOST: ${HOST:-0.0.0.0}
      APP_NAME: ${APP_NAME:-Notable Nomads Backend API}
      APP_DESCRIPTION: ${APP_DESCRIPTION:-Notable Nomads Backend API}
      APP_VERSION: ${APP_VERSION:-v0.0.30}
      API_PREFIX: ${API_PREFIX:-v1}
      CORS_ENABLED_DOMAINS: ${CORS_ENABLED_DOMAINS:-*.notablenomads.com,notablenomads.com,nn-landing.vercel.app,localhost:3000,localhost:8080}
      CORS_RESTRICT: ${CORS_RESTRICT:-true}
      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      # Database
      DATABASE_HOST: ${DATABASE_HOST:-postgres}
      DATABASE_PORT: ${DATABASE_PORT:-5432}
      DATABASE_USERNAME: ${DATABASE_USERNAME:-nn-postgres-admin}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: ${DATABASE_NAME:-nn-backend-db-production}
      DATABASE_SCHEMA: ${DATABASE_SCHEMA:-public}
      # AWS SES
      AWS_REGION: ${AWS_REGION:-eu-central-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      # Email
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-no-reply@mail.notablenomads.com}
      EMAIL_TO_ADDRESS: ${EMAIL_TO_ADDRESS:-contact@notablenomads.com}
      # AI
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      # Sentry
      SENTRY_DSN: ${SENTRY_DSN}
      # Monitoring
      MONITORING_MEMORY_THRESHOLD_MS: ${MONITORING_MEMORY_THRESHOLD_MS:-2000}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
    expose:
      - '3000'
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://localhost:${PORT:-3000}/v1/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME:-nn-postgres-admin}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME:-nn-backend-db-production}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    expose:
      - '5432'
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DATABASE_USERNAME:-postgres} -h localhost']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  nginx:
    image: nginx:stable-alpine
    restart: unless-stopped
    ports:
      - '80:80'
    volumes:
      - ${NGINX_CONFIG:-./nginx.dev.conf}:/etc/nginx/conf.d/default.conf:ro
      - ${SSL_CERT_PATH:-/dev/null}:/dev/null
      - ${SSL_WWW_PATH:-/dev/null}:/dev/null
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'nginx -t || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - app-network
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  frontend:
    image: mrdevx/nn-landing:latest
    expose:
      - '3030'
    environment:
      PORT: 3030
      NEXT_PUBLIC_PORT: 3030
      NEXT_PORT: 3030
      HOSTNAME: '0.0.0.0'
    networks:
      - app-network
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
    name: nn_postgres_data
